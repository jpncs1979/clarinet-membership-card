# Google Drive 自動同期機能

サーバー起動中、**定期的にGoogle DriveからCSVを自動でダウンロードして、会員データを更新**します。

---

## 動作

1. **サーバー起動時**：起動後30秒で初回同期を実行
2. **定期実行**：設定した間隔（デフォルト：10分）ごとに自動同期
3. **更新検知**：Drive上のCSVが更新されていれば、自動で `members.json` を更新

---

## 設定方法

### .env に追加

```env
GOOGLE_SERVICE_ACCOUNT_KEY_FILE=google-service-account.json
GOOGLE_DRIVE_FILE_ID=あなたのファイルID
DRIVE_SYNC_INTERVAL_MINUTES=10
```

- `DRIVE_SYNC_INTERVAL_MINUTES`: 同期間隔（分）。デフォルトは10分。0にすると自動同期を無効化

---

## 使い方

### 1. 通常の起動

```powershell
npm start
```

サーバー起動後、自動でDrive同期が開始されます。

### 2. ログの確認

サーバーのコンソールに、以下のようなログが表示されます：

```
[Drive自動同期] 10分ごとに自動同期します
[Drive自動同期] 成功: 466件をインポートしました (2026-02-18T10:30:00.000Z)
```

### 3. CSVを更新する

1. Google Drive に新しいCSVをアップロード（同じファイルIDのファイルを置き換え）
2. 次回の自動同期（最大10分後）で自動反映
3. すぐに反映したい場合は、サーバーを再起動（起動後30秒で同期）

---

## 手動CSV使用時

Google Drive連携を設定しない場合（`.env` に `GOOGLE_DRIVE_FILE_ID` がない場合）は、自動同期はスキップされ、手動で `data/sikuminet.csv` を置いて `node scripts/import-sikuminet-csv.js` を実行する従来の方法が使えます。

---

## トラブルシューティング

### 同期が失敗する

サーバーのログを確認：
- 「鍵ファイルが見つかりません」→ `.env` の `GOOGLE_SERVICE_ACCOUNT_KEY_FILE` を確認
- 「環境変数が設定されていません」→ `.env` に `GOOGLE_DRIVE_FILE_ID` が設定されているか確認
- 「CSVの内容が空です」→ Drive上のCSVファイルを確認

### 同期間隔を変更したい

`.env` の `DRIVE_SYNC_INTERVAL_MINUTES` を変更して、サーバーを再起動してください。

---

## 注意事項

- 自動同期は**サーバーが起動している間のみ**動作します
- クラウド（Render等）にデプロイした場合も、自動同期が動作します
- 同期中にエラーが発生しても、サーバーは停止しません（ログに警告が表示されます）
